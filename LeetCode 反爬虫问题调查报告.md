# LeetCode 反爬虫问题调查报告

## 问题描述

LeetCode 网站对所有问题页面返回 **HTTP 403 Forbidden** 错误，表明网站检测到自动化请求并拒绝访问。

## 403 错误原因分析

### 1. 主要原因

HTTP 403状态码表示服务器理解请求但拒绝授权访问，在网页抓取中通常意味着服务器识别出请求来自自动化工具而非真实用户。

具体触发因素包括：

- **User-Agent 识别**：默认的HTTP库（如Python Requests、Scrapy）会发送能识别出所用库的特征headers，或根本不附加真实浏览器headers
- **缺少必要的 Headers**：缺少如X-Requested-With、X-CSRF-Token、Origin或Referer等关键headers
- **请求模式异常**：请求频率过高、时间间隔固定等机器人行为特征
- **IP 地址被封禁**：网站通常实施速率限制来控制单个IP地址的请求数量
- **反爬虫系统**：LeetCode可能使用Cloudflare等先进的反爬虫保护系统，这些系统会分析请求的各个方面来判断流量是否类似人类

### 2. LeetCode 特定保护

LeetCode 作为一个技术平台，可能采用了：

- **Cloudflare 保护**：最常见的反爬虫系统
- **JavaScript 挑战**：反爬虫措施经常抛出JavaScript挑战以确认请求者是使用浏览器的真人还是机器人
- **动态内容加载**：问题页面使用 React/Vue 等框架进行客户端渲染
- **浏览器指纹识别**：检测浏览器特征、Canvas 指纹等

## 解决方案

### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **改进 Requests** | 轻量、快速、资源占用少 | 无法处理JavaScript渲染、容易被检测 | 简单静态页面 |
| **Selenium** | 成熟稳定、社区支持好、多语言支持 | 较慢、资源占用大、设置复杂 | 需要跨浏览器兼容 |
| **Playwright** ⭐ | 快速、现代API、自动等待、内置网络拦截 | 较新、社区相对小 | **推荐用于LeetCode** |
| **代理服务** | 最可靠、省心 | 付费、成本高 | 大规模商业应用 |

### 推荐方案：Playwright

Playwright在2024-2025年平均比Selenium快35-40%，内存占用少44%，并且对现代JavaScript网站有更好的处理能力。

**为什么选择 Playwright：**

1. **性能优势**：Playwright通过持久WebSocket直接与浏览器通信，减少了中间层延迟
2. **反检测能力**：更好地模拟真实浏览器行为
3. **JavaScript 渲染**：能够渲染JavaScript并解决JavaScript挑战
4. **网络拦截**：可以拦截和修改网络请求
5. **自动等待**：内置智能等待机制，减少超时错误

## 实施策略

### 核心技术要点

1. **浏览器自动化**
   - 使用 Playwright 的 Chromium 引擎
   - 设置真实的浏览器 User-Agent
   - 配置完整的浏览器上下文（viewport、语言等）

2. **请求优化**
   ```python
   - 随机化请求间隔（1-5秒）
   - 模拟人类行为（滚动、移动鼠标）
   - 管理 cookies 和 session
   ```

3. **错误处理**
   - 实现指数退避重试
   - 检测 CAPTCHA 和订阅墙
   - 记录详细日志便于调试

4. **资源优化**
   - 阻止加载图片、字体等非必要资源
   - 使用无头模式节省资源
   - 实现连接池复用浏览器实例

### 反检测最佳实践

要克服403错误需要多层解决方案：

1. **User-Agent 轮换**：使用真实浏览器的 User-Agent
2. **完整 Headers**：模拟浏览器的完整 HTTP headers
3. **速率限制**：控制请求频率，添加随机延迟
4. **Session 管理**：维护 cookies 和 session 状态
5. **行为模拟**：添加页面滚动、等待时间等人类行为

## 注意事项

### 法律与道德

1. **遵守 robots.txt**：检查 LeetCode 的爬虫政策
2. **尊重服务条款**：确保使用符合 LeetCode ToS
3. **合理使用**：
   - 控制请求频率，避免对服务器造成压力
   - 仅用于个人学习和研究
   - 不要转售或重新发布数据

### 技术限制

1. **Premium 内容**：付费问题无法通过爬虫访问
2. **动态内容**：部分内容需要登录才能查看
3. **API 优先**：如果LeetCode提供官方API，应优先使用API而非爬虫

## 成本效益分析

| 方法 | 开发成本 | 维护成本 | 可靠性 | 推荐指数 |
|------|----------|----------|--------|----------|
| Requests + 技巧 | 低 | 高 | 低 | ⭐⭐ |
| Selenium | 中 | 中 | 中 | ⭐⭐⭐ |
| Playwright | 中 | 低 | 高 | ⭐⭐⭐⭐⭐ |
| 付费代理 API | 低 | 低 | 极高 | ⭐⭐⭐⭐ |

## 结论

针对 LeetCode 的反爬虫保护，推荐采用 **Playwright + 合理的请求策略**：

- ✅ 能够处理 JavaScript 渲染
- ✅ 更好地模拟真实浏览器
- ✅ 现代化的 API 和更好的性能
- ✅ 内置反检测优化
- ✅ 适合中小规模爬取任务

对于大规模商业用途，建议考虑：
1. 联系 LeetCode 获取官方 API 访问权限
2. 使用专业的网页抓取服务（如 ScrapingBee、ZenRows）
3. 遵守所有相关法律法规和服务条款